---
title: "Segmenting Trump Twitter Followers Using Spectral Clustering"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)

library(tidyverse) #include ggplot2, dyplyr, readr, tydyr
#library(dygraphs) # dynamic graph
library(xts)
library(Matrix)
library(data.table)
theme_update(plot.title = element_text(hjust = 0.5))

source("function.R")
```

```{r process data, include=FALSE}
followers <- data.table::fread("../results_following/followers_with_cluster_info.csv", colClasses = c("character"))
followers <- data.frame(followers)

#correct variable types
followers$cluster <- as.factor(as.numeric(followers$cluster)) #factor
#data time
#followers$created_at <- as.POSIXct(followers$created_at, format = "%a %b %d %H:%M:%S %z %Y")
followers$created_at <- as.POSIXct(followers$created_at)
followers$first_date_timeline <- as.Date(followers$first_date_timeline)
followers$last_date_timeline <- as.Date(followers$last_date_timeline)

#non-numerical
non_numerical_cols <- c("period","cluster", "clust_label","clust_cat","id_str", "screen_name", 
                        "name",  "description","created_at", "lang",
                        "location", "time_zone", "verified", "first_date_timeline","last_date_timeline")
non_numerical_ids <- match(non_numerical_cols, names(followers))
for( i in 1:ncol(followers)){
  if (!(i %in% non_numerical_ids)){
    followers[[i]] <- as.numeric(followers[[i]]) 
    #followers[which(is.na(followers[[i]])),i] <- 0
    cat("i=", i ,"\n")
  }
}
rm(non_numerical_cols,non_numerical_ids)

# missing values for pg2, pg2_personalized should be NA
# followers[['pg2']][which(followers[['pg2']] == 0)] <- NA
# followers[['pg2_personalized']][which(followers[['pg2_personalized']] == 0)] <- NA
# followers[['pg1_core3']][which(followers[['pg1_core3']] == 0)] <- NA
# followers[['pg1_p_core3']][which(followers[['pg1_p_core3']] == 0)] <- NA

#rename and reorder
followers$clust_cat[followers$clust_cat=="anti-feminist conservatives"] = "men's interests"
followers$clust_cat[followers$clust_cat == "news&regional"] = "news & regional"
followers$clust_cat <- factor(followers$clust_cat, levels = c("Trump supporters", "conservatives", "news & regional", "international", "men's interests", "liberals",  "non-political", "other countries"))
table(followers$clust_cat)

followers$period[followers$period == "before announcement"] = "pre announcement"
followers$period[followers$period == "before primary"] ="primary election"
followers$period[followers$period == "before election"] = "general election"
followers$period = factor(followers$period, levels = c("pre announcement", "primary election", "general election"))
table(followers$period)

```

## Introduction
first version May 31, 2017
updated on Jun 1, Jun 12, June 26






## Part I: Using Pagerank to detect bots.
PageRank was developed to evaluate the importance of web-pages via the link structures. More generally, it can used as a centrality measures of nodes in various networks. 

Here we hypothsize that bots have fewer followers and thus lower pagerank scores. A benefits that pagerank has is that it is difficult for bots to adjust themselves to change the scores. 

We calculate the pagerank scores of each Trump followers, use the verified account as non-bots accounts to see whether there is differences for this scores.

Two pagerank scores presented here

1.Pagerank1 from the network among **377725** followers themseleves.

* Network statistics: 377725 nodes, 20766474 edges, mean degree = 54.98.
   **65.8%** have zero out degree(following nobody); **18.2%** have zero in degree; **12.6%** have zero degrees

* Page rank actually don't work well!  -- not able to ditinguish verified account and regular accounts

2. Pagerank2 from the symmetrized bipartite graph between followers and people they are following (>=10).

* Network statistics: (considered as bipartite graph) 324933 x 9118691, total edges: 525,894,470.
5080581 out 9,118,691 have at least 10 followers in each stage. 9,118,691 have 10 followers among all the sample of 377725(324933).

* no zero degrees. 1190/324933/377725 having <10 friends (out degree); min in degree is 10

* Page rank has more very low scores (1e-7 (~12%, ~2%), 1e-6.5 (37%, 15%)). See the plot below.

```{r loading data}
#load("../report/2017-05-27/report_0601.RData")
#load("../report/2017-05-27/report_0626.RData")
followers$clust_cat <- addNA(followers$clust_cat)
levels(followers$clust_cat)[9] <- "NA"
table(followers$clust_cat)
table(followers$period)
```


```{r}
p0 <- followers %>% group_by(period, clust_cat) %>% summarise(count = n()) %>% 
  ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral") +xlab("")+ggtitle("full data")
```


### Two pageranks

**pagerank 1 (w/o personalization)**

```{r}
p11 <- followers %>% ggplot(aes(x = log10(pg1))) + stat_ecdf(geom="step", aes(group = verified, color = verified )) +labs(x= "pagerank (in log10)", y = "cumulative probability") + ggtitle("pagerank1")

p12 <- followers %>% ggplot(aes(x = log10(pg1_personalized))) + stat_ecdf(geom="step",aes(group = verified, color = verified )) +  labs(x= "pagerank (in log10)", y = "cumulative probability") + ggtitle("pagerank1 personalized")

multiplot(p11, p12,  cols = 2)

# p12 <- ggplot(dat, aes(logpg1, ..density..))+
#   geom_histogram(aes(color=verified,  group = verified),  bins =100, position = "stack")+
#   labs(x= "pagerank (in log10)")
# p13 <- ggplot(dat, aes(logpg1, color=verified, fill = verified ))+
#   geom_density(aes(  group = verified), alpha =0.1,   position = "stack")+ labs(x= "pagerank (in log10)")
# multiplot(p11, p12, p13,  cols = 2)
```


```{r}
p11_1 <- followers %>% ggplot(aes(x = log10(pg1_core3))) + stat_ecdf(geom="step",aes(group = verified, color = verified )) +  labs(x= "pagerank (in log10)", y = "cumulative probability") + ggtitle("pagerank1 on 3-core")

p12_1 <- followers %>% ggplot(aes(x = log10(pg1_p_core3))) + stat_ecdf(geom="step",aes(group = verified, color = verified )) +  labs(x= "pagerank (in log10)", y = "cumulative probability") + ggtitle("pagerank1 personalized on 3-core")
multiplot(p11_1, p12_1,  cols = 2)
```

**pagerank 2 (w/o personalization)**

```{r}
p21 <- followers %>% ggplot(aes(x = log10(pg2))) + stat_ecdf(geom="step",aes(group = verified, color = verified )) + labs(x= "pagerank (in log10)", y = "cumulative probability")+ ggtitle("pagerank2")

p22 <- followers %>% ggplot(aes(x = log10(pg2_personalized))) + stat_ecdf(geom="step",aes(group = verified, color = verified )) +  labs(x= "pagerank (in log10)", y = "cumulative probability") + ggtitle("pagerank2 personalized")
multiplot(p21, p22, cols = 2) 
```



Next, the plots above indicates (espcially for pagerank1), verified account tend to have high scores. Bots tend to have lower scores, let's look at the followers with lowest **5%** of the scores (```X <= quantile(X, 0.05, na.rm = T)+1e-10)```). 
```{r}
#68727 taking minimum values, using 1e-10 breaking 
p31 <- followers %>% subset( pg1 <= (quantile(pg1, 0.05, na.rm = T)+1e-10)) %>% group_by(period, clust_cat) %>% summarise(count = n()) %>% ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ggtitle("tail of pg1")

p31_1 <- followers %>% subset(pg1_personalized <= quantile(pg1_personalized, 0.05, na.rm = T)+1e-10) %>% group_by(period, clust_cat) %>% summarise(count = n()) %>% ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral") +ggtitle(paste0("tail of pg1_personalized"))

p32 <- subset(followers, pg2 <= quantile(pg2, 0.05, na.rm = T)+1e-10)%>% group_by(period, clust_cat) %>% summarise(count = n()) %>% ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ggtitle("tail of pg2")

p32_1 <- subset(followers, pg2_personalized <= quantile(pg2_personalized, 0.05, na.rm = T)+1e-10)%>% group_by(period, clust_cat) %>% summarise(count = n()) %>% ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ggtitle("tail of pg2_personalized")




p33 <- followers %>% 
  subset(pg1_core3 <= quantile(pg1_core3, 0.05, na.rm = T)+1e-10)%>% 
  group_by(period, clust_cat) %>% summarise(count = n()) %>% 
  ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral") + ggtitle("tail of pagerank_core3")

p33_1 <- followers %>% 
  subset(pg1_p_core3 <= quantile(pg1_p_core3, 0.05, na.rm = T)+1e-10)%>% 
  group_by(period, clust_cat) %>% summarise(count = n()) %>% 
  ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral") + ggtitle("tail of pagerank_p_core3")


p34 <- subset(followers,followers_count <= quantile(followers_count, 0.05, na.rm = T)+1e-10)%>% group_by(period, clust_cat) %>% summarise(count = n()) %>% ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ggtitle("tail of followers_count")

p35 <- followers %>% 
  mutate(followers_following = log10((followers_count+1)/(1+friends_count)))%>%
  subset(followers_following <= quantile(followers_following, 0.05, na.rm = T)+1e-10)%>% 
  group_by(period, clust_cat) %>% summarise(count = n()) %>% 
  ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ ggtitle("tail of followers_counts friends_counts ratio")

p36 <- followers %>% 
    mutate(retweet_total = RT_only+ RT_comments)%>%
    subset(retweet_total >= quantile(retweet_total, 0.95, na.rm = T)+1e-10)%>% 
  group_by(period, clust_cat) %>% summarise(count = n()) %>% 
  ggplot(aes(x = period, y = count, fill = clust_cat, label = clust_cat)) +
  geom_bar(stat = "identity" ) +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_brewer(palette="Spectral")+ ggtitle("Right tail of retweet count total")

```

**The tails part of pagerank1, pagerank2, etc **

```{r tail part of PageRanks}

# pdf("tail_bots.pdf", onefile = TRUE)

multiplot(p0, p31, cols = 2)

multiplot(p0, p31_1, cols = 2)

multiplot(p0, p32, cols = 2)

multiplot(p0, p32_1, cols = 2)

multiplot(p0, p33, cols = 2)

multiplot(p0, p33_1, cols = 2)

multiplot(p0, p34, cols = 2)

multiplot(p0, p35, cols = 2)

multiplot(p0, p36, cols = 2)

#dev.off()


cor(followers[,c("followers_count", "friends_count", "count_mean_timeline",'pg1', 'pg1_personalized','pg2', 'pg2_personalized','pg1_core3', "pg1_p_core3")], use = 'pairwise.complete.obs')

```


**PageRank Scores within each clusters**

```{r, eval = FALSE}
followers  %>% ggplot(aes(log10(pg1))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank1")

followers  %>% ggplot(aes(log10(pg1_core3))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank1 on 3-core")

followers  %>% ggplot(aes(log10(pg2))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank2")

followers  %>% ggplot(aes(log10(pg1_personalized))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank1 personalized")

followers  %>% ggplot(aes(log10(pg1_p_core3))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank1 personalized on 3-core")

followers  %>% ggplot(aes(log10(pg2_personalized))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+labs(title = "pagerank2 personalized")

```


##Part II verifying the clsutering

In this part, I did the following things:

1. visualize the similarity among 50 clusters in each of the three stages (clusters are ordered based on the category names)

2. explore [sparseAHC](https://github.com/khabbazian/sparseAHC), algorithm doing clustering based on the similarity graph. This is trying to verified 1, the performance of the algorithms; 2, justify that the combining the 50 clusters into 8 categories is valid.

3. the results: 
  + the overlapping between sparseAHC and manually combined labels is low.
  + the balloon plot show that the similarity among Trump supporters are realatively high.
  
  
## Some Validation about tweet counts

- Address potential issues, 3200 tweets, may not cover all the tweets, definitely not covered (10.5%), and (12.8%) we don't have their timeline -- due to privacy or no tweets.
```{r}
# clearly truncatation for total at 3200 
table((followers$first_date_timeline > as.Date('2015-06-16'))*(followers$count_total_timeline > 3200), followers$period)
sum((followers$first_date_timeline > as.Date('2015-06-16'))*(followers$count_total_timeline > 3200), na.rm = T)/nrow(followers)
sum(is.na(followers$first_date_timeline))/nrow(followers)
```

- Account started to following Trump at different time. Currently, constraint to 3 following stages, Trump followers always tweets more frequently.

```{r}
p91 <- followers  %>% ggplot(aes(log10(1+count_mean_timeline))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+facet_grid(period~.)
p91
```

```{r}
followers  %>% mutate(retweet_ajusted = log10(1+retweet_trump_count)/(log10(1+count_total_timeline))) %>%ggplot(aes(retweet_ajusted)) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")+facet_grid(period~.)
```

##Part III visualization of some variables.

**Interaction among Followers segements and Tweets Topics**

```{r}
f1 = followers %>% gather(`campaign.slogan`:`via_at`, key = "topic", value = "count") %>% mutate (count = as.numeric(count))

#16
f1$topic[f1$topic == "announce.media.presence.1"] = "campaign tweets"
f1$topic[f1$topic == "announce.media.presence.2"] = "campaign tweets"
f1$topic[f1$topic == "announce.media.presence.and.crticize.media"] = "campaign tweets"
f1$topic[f1$topic == "announce.media.presence"] = "campaign tweets"
f1$topic[f1$topic == "call.for.support"] = "campaign tweets"
f1$topic[f1$topic == "call.for.vote"] = "campaign tweets"
f1$topic[f1$topic == "call.for.vote.1"] = "campaign tweets"
f1$topic[f1$topic == "campaign.slogan.1"] = "campaign tweets"
f1$topic[f1$topic == "campaign.slogan.2"] = "campaign tweets"
f1$topic[f1$topic == "campaign.slogan"] = "campaign tweets"
f1$topic[f1$topic == "campaign.stops.1"] = "campaign tweets"
f1$topic[f1$topic == "campaign.stops"] = "campaign tweets"
f1$topic[f1$topic == "join_us"] = "campaign tweets"
f1$topic[f1$topic == "thank_you"] = "campaign tweets"
f1$topic[f1$topic == "express.appreciation.1"] = "campaign tweets"
f1$topic[f1$topic == "express.appreciation"] = "campaign tweets"

f1$topic[f1$topic == "criticize.opponents.1"] = "criticize opponents"
f1$topic[f1$topic == "criticize.opponents.2"] = "criticize opponents"
f1$topic[f1$topic == "criticize.opponents.3"] = "criticize opponents"
f1$topic[f1$topic == "criticize.MR"] = "criticize opponents"
f1$topic[f1$topic == "criticize.TC"] = "criticize opponents"
f1$topic[f1$topic == "criticize.opponents"] = "criticize opponents"

f1$topic[f1$topic == "praise.surrogates.1"] = "endorsement & surrogates"
f1$topic[f1$topic == "praise.surrogates"] = "endorsement & surrogates"
f1$topic[f1$topic == "retweet_endorse"] = "endorsement & surrogates"
f1$topic[f1$topic == "cite.positive.news"] = "endorsement & surrogates"
f1$topic[f1$topic == "via_at"] = "endorsement & surrogates"

f1$topic[f1$topic == "border..trade.and.jobs"] = "border, trade & jobs"
f1$topic[f1$topic == "criticize.HRC"] = "criticize HRC"
f1$topic[f1$topic == "criticize.media"] = "criticize media"
f1$topic[f1$topic == "criticize.the.establishment"] = "criticize the establishment"
f1$topic[f1$topic == "great.poll.number"] = "great poll numbers"

f1$topic = factor(f1$topic, levels = c("campaign tweets", "endorsement & surrogates", "great poll numbers", "border, trade & jobs", "criticize opponents", "criticize the establishment", "criticize HRC", "criticize media"))

f1 %>% group_by(clust_cat, topic) %>% summarise(total_retweet_count = sum(count)) %>% ggplot(aes(x = clust_cat, y = total_retweet_count, fill = topic)) + geom_bar(stat = "identity", position = "fill") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + xlab("Cluster type") + ylab("Percentage of topics") + ggtitle("Retweet only") + scale_fill_brewer(palette = "Set2")

f1 %>% group_by(clust_cat, topic) %>% summarise(total_retweet_count = sum(count)) %>% ggplot(aes(x = topic, y = total_retweet_count, fill = clust_cat)) + geom_bar(stat = "identity", position = "fill") + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + xlab("Topic type") + ylab("Percentage of segments") + ggtitle("Retweet only") + scale_fill_brewer(palette = "Set2")

```


```{r}
followers %>% mutate(log_daily_count = log10(1+count_mean_timeline)) %>% ggplot(aes(x = log_daily_count)) + geom_histogram(stat = "bin",  binwidth = 0.05) +labs(x = "average daily tweets (in log10)")
                 


followers %>% mutate(log_total_count = log10(1+count_total_timeline)) %>% ggplot(aes(x = log_total_count)) +
  geom_histogram(stat = "bin",  binwidth = 0.1) +labs(x = "total tweets from timeline (in log10)")

followers %>% mutate(ndays = count_total_timeline/count_mean_timeline) %>%
  ggplot(aes(ndays)) + geom_histogram(aes(group= clust_cat, color= clust_cat), bins = 50, position = "stack")

p51 <- followers %>% mutate(ndays = count_total_timeline/count_mean_timeline) %>%
  ggplot(aes(ndays)) +stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")

p52 <-followers %>% mutate(ndays = count_total_timeline/count_mean_timeline) %>%
  ggplot(aes(ndays)) + geom_histogram(aes( color= clust_cat),binwidth = 30)+facet_grid(clust_cat~.)

p53<- followers %>% mutate(ndays = count_total_timeline/count_mean_timeline) %>%
  ggplot(aes(ndays))+
  geom_density(aes(color= clust_cat, fill = clust_cat), alpha =0.1,   position = "stack")+facet_grid(clust_cat~.)
p51
p52
p53
```


```{r}
p61 <- followers  %>% ggplot(aes(created_at)) +
  geom_density(aes(color= clust_cat, fill = clust_cat), alpha =0.1,   position = "stack")+facet_grid(clust_cat~.)

p62 <- followers  %>% subset(created_at > as.Date('2015-06-16')) %>%ggplot(aes(created_at)) +
  geom_density(aes(color= clust_cat, fill = clust_cat), alpha =0.1,   position = "stack")+facet_grid(clust_cat~.)
p61
p62
```

```{r}
p71 <- followers  %>% subset(created_at > as.Date('2015-06-16')) %>%ggplot(aes(log10(count_mean_timeline))) +
  geom_density(aes(color= clust_cat, fill = clust_cat), alpha =0.1,   position = "stack")+facet_grid(clust_cat~.)

p72 <- followers  %>% subset(created_at > as.Date('2015-06-16'))%>% ggplot(aes(log10(count_mean_timeline))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")
p71
p72
```

```{r}
p81 <- followers %>% ggplot(aes(log10(1+count_mean_timeline))) +
  geom_density(aes(color= clust_cat, fill = clust_cat), alpha =0.1,   position = "stack")+facet_grid(clust_cat~.)

p82 <- followers  %>% ggplot(aes(log10(1+count_mean_timeline))) +
  stat_ecdf(geom="step",aes(group= clust_cat, color= clust_cat )) + 
  labs(y = "cumulative probability")

p81

p82
``` 

## Discussion 
pote




